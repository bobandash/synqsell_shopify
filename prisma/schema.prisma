generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id                           String                 @id
  shop                         String
  state                        String
  isOnline                     Boolean                @default(false)
  scope                        String?
  expires                      DateTime?              @db.Timestamp(6)
  accessToken                  String
  userId                       BigInt?
  firstName                    String?
  lastName                     String?
  email                        String?
  accountOwner                 Boolean                @default(false)
  locale                       String?
  collaborator                 Boolean?               @default(false)
  emailVerified                Boolean?               @default(false)
  carrierService               CarrierService?
  checklistStatuses            ChecklistStatus[]
  fulfillmentService           FulfillmentService?
  importedProducts             ImportedProduct[]
  retailerPartnerships         Partnership[]          @relation("RetailerPartnership")
  supplierPartnerships         Partnership[]          @relation("SupplierPartnership")
  recipientPartnershipRequests PartnershipRequest[]   @relation("RecipientPartnershipRequest")
  senderPartnershipRequests    PartnershipRequest[]   @relation("SenderPartnershipRequest")
  priceLists                   PriceList[]
  roles                        Role[]
  supplierAccessRequest        SupplierAccessRequest?
  userPreference               UserPreference?
  userProfile                  UserProfile?
  retailerOrders               Order[]                @relation("RetailerOrder")
  supplierOrders               Order[]                @relation("SupplierOrder")
}

model FulfillmentService {
  id                          String  @id @default(uuid())
  sessionId                   String  @unique
  shopifyFulfillmentServiceId String
  shopifyLocationId           String
  session                     Session @relation(fields: [sessionId], references: [id])
}

model UserPreference {
  id             String   @id @default(uuid())
  tableIdsHidden String[]
  sessionId      String   @unique
  session        Session  @relation(fields: [sessionId], references: [id])
}

model ChecklistTable {
  id             String          @id @default(uuid())
  position       Int
  header         String
  subheader      String?
  checklistItems ChecklistItem[]
}

model ChecklistItem {
  id                String            @id @default(uuid())
  key               String            @unique
  checklistTableId  String
  position          Int
  header            String
  subheader         String?
  buttonText        String?
  checklistTable    ChecklistTable    @relation(fields: [checklistTableId], references: [id])
  checklistStatuses ChecklistStatus[]
}

model ChecklistStatus {
  id                    String                 @id @default(uuid())
  checklistItemId       String
  isCompleted           Boolean
  sessionId             String
  checklistItem         ChecklistItem          @relation(fields: [checklistItemId], references: [id])
  session               Session                @relation(fields: [sessionId], references: [id])
  supplierAccessRequest SupplierAccessRequest?
}

model SupplierAccessRequest {
  checklistStatusId       String          @unique
  hasMetSalesThreshold    Boolean
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @default(now())
  status                  String
  sessionId               String          @unique
  notes                   String?
  isEligibleForNewRequest Boolean         @default(true)
  id                      String          @id @default(uuid())
  num                     Int             @default(autoincrement())
  checklistStatus         ChecklistStatus @relation(fields: [checklistStatusId], references: [id])
  session                 Session         @relation(fields: [sessionId], references: [id])
}

model Role {
  id                 String   @id @default(uuid())
  name               String
  sessionId          String
  createdAt          DateTime @default(now())
  isVisibleInNetwork Boolean  @default(true)
  session            Session  @relation(fields: [sessionId], references: [id])
}

model UserProfile {
  id              String           @id @default(uuid())
  name            String
  email           String
  logo            String?
  biography       String?
  desiredProducts String?
  sessionId       String           @unique
  address         String?
  website         String
  currencyCode    String           @default("USD")
  socialMediaLink SocialMediaLink?
  session         Session          @relation(fields: [sessionId], references: [id])
}

model SocialMediaLink {
  id            String      @id @default(uuid())
  facebook      String?
  twitter       String?
  instagram     String?
  youtube       String?
  tiktok        String?
  userProfileId String      @unique
  userProfile   UserProfile @relation(fields: [userProfileId], references: [id])
}

model PriceList {
  id                       String               @id @default(uuid())
  createdAt                DateTime             @default(now())
  pricingStrategy          String
  supplierId               String
  isGeneral                Boolean
  name                     String
  requiresApprovalToImport Boolean?
  margin                   Int?
  session                  Session              @relation(fields: [supplierId], references: [id])
  products                 Product[]
  partnershipRequests      PartnershipRequest[] @relation("PartnershipRequestToPriceList")
  partnerships             Partnership[]        @relation("PartnershipToPriceList")
  orderLineItems           OrderLineItem[]
}

model PartnershipRequest {
  id          String      @id @default(uuid())
  senderId    String
  recipientId String
  message     String
  status      String
  type        String
  createdAt   DateTime    @default(now())
  recipient   Session     @relation("RecipientPartnershipRequest", fields: [recipientId], references: [id])
  sender      Session     @relation("SenderPartnershipRequest", fields: [senderId], references: [id])
  priceLists  PriceList[] @relation("PartnershipRequestToPriceList")
}

model Partnership {
  id         String      @id @default(uuid())
  retailerId String
  supplierId String
  createdAt  DateTime    @default(now())
  message    String
  retailer   Session     @relation("RetailerPartnership", fields: [retailerId], references: [id])
  supplier   Session     @relation("SupplierPartnership", fields: [supplierId], references: [id])
  priceLists PriceList[] @relation("PartnershipToPriceList")
}

model Product {
  id               String            @id @default(uuid())
  priceListId      String
  shopifyProductId String
  createdAt        DateTime          @default(now())
  importedProducts ImportedProduct[]
  priceList        PriceList         @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  variants         Variant[]
}

model Variant {
  id               String            @id @default(uuid())
  productId        String
  shopifyVariantId String
  retailPrice      String
  retailerPayment  String
  supplierProfit   String
  importedVariants ImportedVariant[]
  inventoryItem    InventoryItem?
  product          Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model InventoryItem {
  id                     String                  @id @default(uuid())
  variantId              String                  @unique
  shopifyInventoryItemId String
  ImportedInventoryItem  ImportedInventoryItem[]
  variant                Variant                 @relation(fields: [variantId], references: [id], onDelete: Cascade)
}

model ImportedProduct {
  id               String            @id @default(uuid())
  retailerId       String
  importedAt       DateTime          @default(now())
  prismaProductId  String
  shopifyProductId String
  prismaProduct    Product           @relation(fields: [prismaProductId], references: [id], onDelete: Cascade)
  session          Session           @relation(fields: [retailerId], references: [id])
  importedVariants ImportedVariant[]
}

model ImportedVariant {
  id                    String                 @id @default(uuid())
  importedProductId     String
  prismaVariantId       String
  shopifyVariantId      String
  importedInventoryItem ImportedInventoryItem?
  importedProduct       ImportedProduct        @relation(fields: [importedProductId], references: [id], onDelete: Cascade)
  primaVariant          Variant                @relation(fields: [prismaVariantId], references: [id], onDelete: Cascade)
}

model ImportedInventoryItem {
  id                     String          @id @default(uuid())
  shopifyInventoryItemId String
  importedVariantId      String          @unique
  prismaInventoryItemId  String
  importedVariant        ImportedVariant @relation(fields: [importedVariantId], references: [id], onDelete: Cascade)
  prismaInventoryItem    InventoryItem   @relation(fields: [prismaInventoryItemId], references: [id], onDelete: Cascade)
}

model CarrierService {
  id                      String  @id @default(uuid())
  retailerId              String  @unique
  shopifyCarrierServiceId String
  retailer                Session @relation(fields: [retailerId], references: [id])
}

model Order {
  id                                String          @id @default(uuid())
  currency                          String
  shopifyRetailerFulfillmentOrderId String
  shopifySupplierOrderId            String
  retailerId                        String
  supplierId                        String
  shippingCost                      Decimal         @default(0) @db.Decimal(10, 2)
  paymentStatus                     String // CAN BE INCOMPLETE, PARTIALLY_PAID, or PAID
  createdAt                         DateTime        @default(now())
  updatedAt                         DateTime        @default(now())
  retailer                          Session         @relation("RetailerOrder", fields: [retailerId], references: [id])
  supplier                          Session         @relation("SupplierOrder", fields: [supplierId], references: [id])
  payments                          Payment[]
  orderLineItems                    OrderLineItem[]
  fulfillments                      Fulfillment[]
}

model Fulfillment {
  id                           String @id @default(uuid())
  supplierShopifyFulfillmentId String
  retailerShopifyFulfillmentId String
  orderId                      String
  order                        Order  @relation(fields: [orderId], references: [id])
}

model OrderLineItem {
  id                             String    @id @default(uuid())
  retailerShopifyVariantId       String
  supplierShopifyVariantId       String
  retailPricePerUnit             Decimal   @db.Decimal(10, 2)
  amountPayablePerUnit           Decimal   @db.Decimal(10, 2) // retrieve the supplier agreed upon profit
  shopifyRetailerOrderLineItemId String
  shopifySupplierOrderLineItemId String
  quantity                       Int
  quantityFulfilled              Int       @default(0)
  quantityPaid                   Int       @default(0)
  quantityCancelled              Int       @default(0)
  orderId                        String
  priceListId                    String
  order                          Order     @relation(fields: [orderId], references: [id])
  priceList                      PriceList @relation(fields: [priceListId], references: [id])
}

model Payment {
  id            String   @id @default(uuid())
  orderId       String
  stripeEventId String   @unique
  status        String // need to listen to stripe's webhooks for this
  amount        Decimal  @db.Decimal(10, 2)
  createdAt     DateTime @default(now())
  order         Order    @relation(fields: [orderId], references: [id])
}
