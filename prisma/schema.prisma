// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string

// Common commands: 
// npx prisma migrate dev

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// by default generated by shopify (after auth)
// this is offline access, which does not expire until the user removes the application
// Before deployment, refactor so that all the database items are connected to the session instead of having its own shop field
model Session {
  id                           String                 @id
  shop                         String
  state                        String
  isOnline                     Boolean                @default(false)
  scope                        String?
  expires                      DateTime?              @db.Timestamp
  accessToken                  String
  userId                       BigInt?
  firstName                    String?
  lastName                     String?
  email                        String?
  accountOwner                 Boolean                @default(false)
  locale                       String?
  collaborator                 Boolean?               @default(false)
  emailVerified                Boolean?               @default(false)
  userPreference               UserPreference?
  fulfillmentService           FulfillmentService?
  supplierAccessRequest        SupplierAccessRequest?
  userProfile                  UserProfile?
  shippingProfile              ShippingProfile?
  roles                        Role[]
  checklistStatuses            ChecklistStatus[]
  priceLists                   PriceList[]
  importedProducts             ImportedProduct[]
  retailerPartnerships         Partnership[]          @relation("RetailerPartnership")
  supplierPartnerships         Partnership[]          @relation("SupplierPartnership")
  senderPartnershipRequests    PartnershipRequest[]   @relation("SenderPartnershipRequest")
  recipientPartnershipRequests PartnershipRequest[]   @relation("RecipientPartnershipRequest")
}

model FulfillmentService {
  id                          String  @id @default(uuid())
  shopifyFulfillmentServiceId String
  shopifyLocationId           String
  Session                     Session @relation(fields: [sessionId], references: [id])
  sessionId                   String  @unique
}

model UserPreference {
  id             String   @id @default(uuid())
  session        Session  @relation(fields: [sessionId], references: [id])
  tableIdsHidden String[]
  sessionId      String   @unique
}

model ChecklistTable {
  id             String          @id @default(uuid())
  position       Int
  header         String
  subheader      String?
  checklistItems ChecklistItem[]
}

model ChecklistItem {
  id                String            @id @default(uuid())
  key               String            @unique
  checklistTable    ChecklistTable    @relation(fields: [checklistTableId], references: [id])
  checklistTableId  String
  position          Int
  header            String
  subheader         String?
  buttonText        String?
  checklistStatuses ChecklistStatus[]
}

model ChecklistStatus {
  id                    String                 @id @default(uuid())
  session               Session                @relation(fields: [sessionId], references: [id])
  sessionId             String
  checklistItem         ChecklistItem          @relation(fields: [checklistItemId], references: [id])
  checklistItemId       String
  isCompleted           Boolean
  supplierAccessRequest SupplierAccessRequest?
}

model Role {
  id                 String   @id @default(uuid())
  name               String
  session            Session  @relation(fields: [sessionId], references: [id])
  sessionId          String
  createdAt          DateTime @default(now())
  isVisibleInNetwork Boolean  @default(true)
}

model UserProfile {
  id              String           @id @default(uuid())
  name            String
  website         String
  address         String?
  email           String
  logo            String?
  biography       String?
  desiredProducts String?
  sessionId       String           @unique
  session         Session          @relation(fields: [sessionId], references: [id])
  socialMediaLink SocialMediaLink?
}

model SocialMediaLink {
  id            String      @id @default(uuid())
  facebook      String?
  twitter       String?
  instagram     String?
  youtube       String?
  tiktok        String?
  userProfile   UserProfile @relation(fields: [userProfileId], references: [id])
  userProfileId String      @unique
}

// Supplier and Retailer Functionality
// Price list and product
model PriceList {
  id                       String               @id @default(uuid())
  createdAt                DateTime             @default(now())
  name                     String
  isGeneral                Boolean // There can only be one general price list, this is what products are visible on the products page
  requiresApprovalToImport Boolean? // if the price list is a general price list, suppliers can decide whether or not retailers have to request permission to import their products
  pricingStrategy          String
  supplierId               String
  margin                   Int?
  session                  Session              @relation(fields: [supplierId], references: [id])
  products                 Product[]
  partnershipRequests      PartnershipRequest[]
  partnerships             Partnership[]
}

model Product {
  id               String            @id @default(uuid())
  shopifyProductId String
  categoryId       String?
  productType      String
  description      String
  descriptionHtml  String
  status           String
  vendor           String
  title            String
  variantsCount    Int               @default(1)
  priceListId      String
  priceList        PriceList         @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  importedProducts ImportedProduct[]
  images           Image[]
  variants         Variant[]
  createdAt        DateTime          @default(now())
}

model Image {
  id               String  @id @default(uuid())
  productId        String
  url              String
  alt              String
  mediaContentType String
  position         Int
  product          Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// Fields for variants
// https://shopify.dev/docs/api/admin-graphql/2024-07/mutations/productVariantsBulkCreate
// TODO: I ignored media / image for now for variants
// TODO: create it when you add the import
// TODO: google who pays for tax
model Variant {
  id                String            @id @default(uuid())
  shopifyVariantId  String
  compareAtPrice    String?
  productId         String
  inventoryPolicy   String
  inventoryQuantity Int?
  price             String
  wholesalePrice    Int?
  taxCode           String?
  taxable           Boolean
  barcode           String?
  product           Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventoryItem     InventoryItem?
  variantOptions    VariantOption[]
  importedVariants  ImportedVariant[]
}

// Fields removed form shopify: countryHarmonizedSystemCodes
// Fields simplified: weightUnit and weightValue

model InventoryItem {
  id                   String  @id @default(uuid())
  countryCodeOfOrigin  String?
  harmonizedSystemCode String?
  weightUnit           String?
  weightValue          Int?
  provinceCodeOfOrigin String?
  requiresShipping     Boolean
  sku                  String?
  tracked              Boolean
  variantId            String  @unique
  variant              Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)
}

// There are some extra fields in variant option that I didn't include
model VariantOption {
  id        String  @id @default(uuid())
  variantId String
  name      String
  value     String
  variant   Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)
}

// End models for variants

// Start fields for shipping profile
// Just for mvp, you can distribute anywhere w/ shipping zones
model ShippingProfile {
  id               String          @id @default(uuid())
  shopifyProfileId String
  name             String
  supplierId       String          @unique
  supplier         Session         @relation(fields: [supplierId], references: [id])
  locationGroup    LocationGroup[]
}

model LocationGroup {
  id                String          @id @default(uuid())
  shopifyLocationId String
  shippingProfileId String
  shippingProfile   ShippingProfile @relation(fields: [shippingProfileId], references: [id])
  zones             Zone[]
}

model Zone {
  id               String            @id @default(uuid())
  name             String
  shopifyZoneId    String
  locationGroupId  String
  locationGroup    LocationGroup     @relation(fields: [locationGroupId], references: [id])
  countries        Country[]
  modelDefinitions ModelDefinition[]
}

// Note: right now, we are only implementing rate definition (charge different shipping rates per territory)
// TODO: may need to implement other shipping methods in the future, depending on user feedback
model ModelDefinition {
  id             String          @id @default(uuid())
  zoneId         String
  zone           Zone            @relation(fields: [zoneId], references: [id])
  rateDefinition RateDefinition?
}

model RateDefinition {
  id                      String          @id @default(uuid())
  shopifyRateDefinitionId String
  priceAmount             String
  priceCurrencyCode       String
  modelDefinitionId       String          @unique
  modelDefinition         ModelDefinition @relation(fields: [modelDefinitionId], references: [id])
}

model Country {
  id                  String     @id @default(uuid())
  code                String     @db.Char(2)
  includeAllProvinces Boolean
  restOfWorld         Boolean
  zoneId              String
  provinces           Province[]
  zone                Zone       @relation(fields: [zoneId], references: [id])
}

model Province {
  id        String  @id @default(uuid())
  code      String
  countryId String
  country   Country @relation(fields: [countryId], references: [id])
}

// Models for imported products
model ImportedProduct {
  id                          String                       @id @default(uuid())
  prismaProductId             String
  shopifyProductId            String
  retailerId                  String
  importedAt                  DateTime                     @default(now())
  prismaProduct               Product                      @relation(fields: [prismaProductId], references: [id])
  session                     Session                      @relation(fields: [retailerId], references: [id])
  importedVariants            ImportedVariant[]
  importedProductTransactions ImportedProductTransaction[]
}

model ImportedVariant {
  id                String          @id @default(uuid())
  importedProductId String
  prismaVariantId   String
  primaVariant      Variant         @relation(fields: [prismaVariantId], references: [id])
  importedProduct   ImportedProduct @relation(fields: [importedProductId], references: [id])
}

model ImportedProductTransaction {
  id                String          @id @default(uuid())
  importedProductId String
  createdAt         DateTime
  fulfilledAt       DateTime
  unitSales         Int
  importedProduct   ImportedProduct @relation(fields: [importedProductId], references: [id])
}

model SupplierAccessRequest {
  id                      String          @id @default(uuid())
  num                     Int             @default(autoincrement())
  checklistStatusId       String          @unique
  hasMetSalesThreshold    Boolean
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @default(now())
  status                  String
  sessionId               String          @unique
  notes                   String?
  isEligibleForNewRequest Boolean         @default(true) // This variable is just in case we reject a supplier and they are not allowed to relist on our app
  checklistStatus         ChecklistStatus @relation(fields: [checklistStatusId], references: [id])
  session                 Session         @relation(fields: [sessionId], references: [id])
}

model PartnershipRequest {
  id          String      @id @default(uuid())
  createdAt   DateTime    @default(now())
  senderId    String
  recipientId String
  message     String
  type        String // two types, retailer request and supplier request
  status      String // can only be rejected or pending; if it is accepted already, it will just make the user into a price list retailer
  priceLists  PriceList[]
  sender      Session     @relation("SenderPartnershipRequest", fields: [senderId], references: [id])
  recipient   Session     @relation("RecipientPartnershipRequest", fields: [recipientId], references: [id])
}

model Partnership {
  id         String      @id @default(uuid())
  createdAt  DateTime    @default(now())
  retailerId String
  supplierId String
  message    String
  priceLists PriceList[]
  retailer   Session     @relation("RetailerPartnership", fields: [retailerId], references: [id])
  supplier   Session     @relation("SupplierPartnership", fields: [supplierId], references: [id])
}
